<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>上报监控数据 - Untitled</title>
    
    
</head>
<body>
<div id="root"></div>
<script type="application/payload+json">
{"id":"Jrymro","sha":"164504e743217af9f2c75534a7496bb2b403bd27","summary":[{"title":"","articles":[{"title":"安装说明","ref":"installation.md","path":"installation.html","metadata":{"mtime":"2021-08-26T04:02:01+00:00"},"children":[{"title":"tracker服务端","ref":"installation\/server.md","path":"installation\/server.html","metadata":{"mtime":"2020-10-01T02:43:42+00:00"},"children":[{"title":"数据存储","ref":"installation\/server\/data-storage.md","path":"installation\/server\/data-storage.html","metadata":{"mtime":"2020-03-05T02:13:12+00:00"}},{"title":"更换数据存储配置","ref":"change-db.md","path":"change-db.html","metadata":{"mtime":"2020-09-23T06:27:02+00:00"}},{"title":"Server管理","ref":"installation\/server\/manage.md","path":"installation\/server\/manage.html","metadata":{"mtime":"2020-02-28T03:05:17+00:00"}},{"title":"数据清理","ref":"installation\/clean-log.md","path":"installation\/clean-log.html","metadata":{"mtime":"2021-08-25T06:03:28+00:00"}}]},{"title":"tracker客户端","ref":"installation\/client.md","path":"installation\/client.html","metadata":{"mtime":"2021-08-26T04:02:01+00:00"},"children":[{"title":"系统配置","ref":"installation\/client\/agent-config.md","path":"installation\/client\/agent-config.html","metadata":{"mtime":"2020-09-17T11:29:08+00:00"}},{"title":"自定义配置","ref":"installation\/client\/user-config.md","path":"installation\/client\/user-config.html","metadata":{"mtime":"2021-09-06T02:37:48+00:00"}},{"title":"链路追踪扩展","ref":"installation\/client\/trace_tlist.md","path":"installation\/client\/trace_tlist.html","metadata":{"mtime":"2021-09-06T02:37:48+00:00"}}]},{"title":"上报监控数据","ref":"installation\/reprot.md","path":"installation\/reprot.html","metadata":{"mtime":"2021-09-08T09:58:59+00:00"}}]},{"title":"名词解释","ref":"noun-interpretation.md","path":"noun-interpretation.html"},{"title":"常见问题","ref":"qa.md","path":"qa.html"},{"title":"首页","ref":"application-list.md","path":"application-list.html"},{"title":"调用统计","ref":"application-monitoring.md","path":"application-monitoring.html"},{"title":"链路追踪","ref":"application-tracking.md","path":"application-tracking.html"},{"title":"调试器适用场景","ref":"debug-explain.md","path":"debug-explain.html"},{"title":"调试器","ref":"debuger.md","path":"debuger.html"},{"title":"免费内存检测工具","ref":"leak.md","path":"leak.html"},{"title":"Agent列表","ref":"agent-list.md","path":"agent-list.html"},{"title":"机器信息","ref":"sysinfo.md","path":"sysinfo.html"},{"title":"报警管理","ref":"alert.md","path":"alert.html"},{"title":"项目管理","ref":"project.md","path":"project.html"},{"title":"应用管理","ref":"module.md","path":"module.html"},{"title":"接口管理","ref":"interface.md","path":"interface.html"},{"title":"用户管理","ref":"user.md","path":"user.html","children":[{"title":"第三方登录","ref":"user\/oauth-login.md","path":"user\/oauth-login.html"}]},{"title":"对外开放API","ref":"api.md","path":"api.html"},{"title":"联系我们","ref":"contact-us.md","path":"contact-us.html"}]}],"config":{"plugins":["highlight","image-zoom"],"pluginsConfig":{"highlight":{"defaultLanguage":"markup"},"theme-default":{"show_nav":true,"logo":{"image":"https:\/\/img.kancloud.cn\/4e\/45\/4e45172f86ac746e40eb69c2827ae271_157x77.png","url":"https:\/\/business.swoole.com\/"}}},"themeConfig":{"expandLevel":1,"navs":[{"title":"Swoole Tracker 详细手册","url":"http:\/\/wiki.tracker.swoole-cloud.com"},{"title":"基础手册","url":"http:\/\/base-wiki.tracker.swoole-cloud.com"}]}},"file":{"path":"installation\/reprot.html","content":"[TOC]\n\n>[success] 上报成功后在后台查看，需要切换当前项目，默认在默认项目中。\n\n![](..\/images\/screenshot_1578041268650.png)\n\n>[danger] 可以先查看链路追踪，首页和调用统计需要时间进行分析。\n\n# FPM 应用\n\n<!--### 自动创建应用-->\n\n默认 tracker 客户端安装了扩展和 agent，并发生了请求，就会自动上报，服务端自动生成对应的应用，并上报监控数据。如果在后台关闭了自动创建应用（默认是开启自动创建的），则需要手动创建应用。\n\n<!--### 手动创建应用\n\n在服务端->系统管理->相应项目->应用管理->新增应用 应用名即为您要监控站点的域名，如有端口请加上端口。\n\n>[info] 例如：您想监控的站点域名为`www.test.com`，服务名则填`www.test.com`（注意：域名若带端口，服务名也要带端口）\n\n配置完成后，稍等片刻即可查看对应的监控数据-->\n\n# Service 应用(Cli 模式)\n\n## 自动创建应用\n\n如果您的 Cli 应用是 `Swoole` 的 `HttpServer` 那么会在发生请求后（OnRequest）自动生成应用，名称为`host:port`\n\n如果您的 Cli 应用是 `Swoole` 的其他类型`Server` 那么会在发生请求后（onReceive）自动生成应用，名称为`ip:port`\n\n>[danger] 当您使用了 Swoole 的多端口监听，自动生成的应用名称只会使用主端口，其他的端口不会生成应用，其他端口的请求拦截到的数据会算到主端口这个应用里面。同时[协程风格的 Swoole 服务端](https:\/\/wiki.swoole.com\/#\/server\/co_init)不支持自动创建应用。\n\n<!--###\n## 手动创建应用\n\n在服务端->系统管理->相应项目->应用管理->新增应用 应用名即为您要监控的服务名。\n\n>[info] 例如：您想监控服务名为`user_service`的cli常驻进程应用，您的应用类型选择Service，服务名填`user_service`.\n-->\n\n## 手动创建应用\n\ncli 下有两种需求需要手动创建应用：\n\n- 自动创建的应用的**名称**不满足需求\n- 不满足自动创建应用的条件，需要手动才能创建应用（例如使用的是 Workerman）\n\n手动创建需要调用 2 个 API：\n\n```php\n \/**\n  * 被调用开始前执行\n  * @param  $func eg.  'App\\Login\\Weibo::login'\n  * @param  $serviceName 应用名称 例如'userService'\n  * @param  $serverIp eg. '192.1.1.1'\n  * @return StatsCenter_Tick object\n  *\/\n$tick = \\SwooleTracker\\Stats::beforeExecRpc($func, $serviceName, $serverIp);\n\n\/**\n * 被调用结束后执行\n * @param $tick  StatsCenter_Tick object\n * @param $ret   true\/false\n * @param $errno 201\n * @return void\n *\/\n\\SwooleTracker\\Stats::afterExecRpc($tick, $ret, $errno);\n```\n\n微服务框架肯定都有统一的服务入口，在服务入口处(开始)加上`beforeExecRpc()`方法，服务出口处(结束)加上`afterExecRpc()`方法。此时后台可以统计到服务的所有链路信息，例如这次调用的 `mysql` `redis`  等调用都会在`afterExecRpc()`后上报，**这两个 API 除了用来生成应用，还可以用来透传**，下文介绍。\n\n# 透传 TraceId\/SpanId\n\n透传的作用是为了分布式 trace，举个例子，浏览器请求机器 A 的 FPM，然后机器 A 的 FPM 调用了机器 B 的 Swoole 服务，正常情况下这会生成 2 个 trace 信息，如果你想让 A=>B 的所有信息合并成一个 trace，一览无余的查看整个链路追踪，就需要把 A 的 TraceId 和 SpanId 透传给服务 B，透传的情况又分为四种：\n\n- `FPM\/Cli` 调用通过`Curl`调用另外一个`FPM`服务\n\n这种情况什么也不用做，tracker 扩展会自动将 TraceId\/SpanId 加到 http 的 header 里面实现透传。\n\n- `FPM\/Cli` 通过`Curl`调用另外一个`Cli`的服务\n\n这种情况需要在 Cli 的服务端的服务入口和出口加上两个函数，分别是 `beforeExecRpc` 和 `afterExecRpc`：\n\n```php\n\/\/伪代码\n$traceId = $header['x-swoole-traceid'];\/\/装了tracker扩展的curl请求会自动带上x-swoole-traceid这个header\n$spanId = $header['x-swoole-spanid'];\/\/同上\n\/\/执行开始函数，把traceId和spanId传给这个函数\n$tick = \\SwooleTracker\\Stats::beforeExecRpc($func, $serviceName, $serverIp, $traceId, $spanId);\n\n\/**\n *  执行真正的业务逻辑\n *\/\n\\SwooleTracker\\Stats::afterExecRpc($tick, $ret, $errno);\/\/调用结束函数\n```\n\n- `FPM\/Cli` 通过 Swoole 的`Http\/Client` 调用另外一个`Cli`的服务：\n\n在 RPC **被调用**端我们的做法同上，不再赘述，在 RPC 调用端我们需要做一些工作：  \n\n```php\n\/\/在Rpc调用的入口加上如下代码，将traceId和spanId塞到header中\n$client->setHeaders(array_merge(\n    [\n        'x-swoole-traceid' => getSwooleTrackerTraceId(),\n        'x-swoole-spanid' => genSwooleTrackerSpanId(),\n    ],\n    $client->requestHeaders\n));\n\n\/**\n * 进行rpc请求\n *\/\n```\n\n- `FPM\/Cli` 通过 `原生TCP协议` 调用另外一个`Cli`的服务：\n\n这个例子有很多，比如`thrift，grpc，tars`, 还有`自定义的rpc协议`等等，此种情况我们需要在调用端和服务端的入口都进行埋点。\n\n在 Rpc 调用端：\n\n```php\n\/\/伪代码\n$traceId =  getSwooleTrackerTraceId();\/\/获取当前traceId\n$spanId = genSwooleTrackerSpanId();\/\/生成一个新的spaId\n\/\/开始请求前调用，注意函数名和Rpc服务端的不一样，这里为Req而不是Exec\n$tick = \\SwooleTracker\\Stats::beforeReqRpc($func, $serviceName, $serverIp);\n\n\/**\n * 进行rpc请求\n *\/\n$testClient = new TestClient();\n\/\/把 $traceId和 $spanId自己想办法带到服务端\n$r = $testClient->client->hello('swoole!'. '|'. $traceId . '|'. $spanid);\n\n\/\/rpc请求结束后调用，注意函数名和Rpc服务端的不一样，这里为Req而不是Exec\n\\SwooleTracker\\Stats::afterReqRpc($tick, $ret, $errno);\n```\n\n在Rpc服务端：\n\n```php\n\/\/伪代码\n$recv = explode(\"|\", $data);\n$traceId = $recv[1];\n$spanId = $recv[2];\/\/从数据中解析出这两个id，也可以自己改rpc协议，直接加到协议头\n\/\/执行开始函数，把traceId和spanId传给这个函数\n$tick = \\SwooleTracker\\Stats::beforeExecRpc($func, $serviceName, $serverIp, $traceId, $spanId);\n\n\/**\n *  执行真正的业务逻辑\n *\/\n\\SwooleTracker\\Stats::afterExecRpc($tick, $ret, $errno);\/\/调用结束函数\n```\n\n# 设置应用名称\n\n如果自动生成的应用名称不符合要求，可以通过两种方式进行设置：\n\n1. 手动调用API\n\n```php\ntracker_set_service_name('your_service_name');\n```\n\n>[danger] Swoole Tracker >= v3.3.0 版本可用。\n\n2. 设置Host\n\n通过使用`CURL`、`Co\\Http\\Client`等方式进行内部调用时，如果是直接基于 `ip:port` 的方式访问，一定要设置一个`host header`，这样可以让`Tracker`知道是哪个应用，否则会把 `ip:port` 当做应用名称。\n\n- CURL\n\n```php\n$headers  = array('Host: your_service_name'); \ncurl_setopt($ch,CURLOPT_HTTPHEADER, $headers);\n```\n\n- Co\\Http\\Client\n\n```php\nuse Swoole\\Coroutine\\Http\\Client;\nuse function Swoole\\Coroutine\\run;\n\nrun(function () {\n    $cli = new Client('127.0.0.1', 9502);\n    $cli->setHeaders(['Host' => 'your_service_name']);\n});\n```\n","meta":{"mtime":"2021-09-08T09:58:59+00:00"}},"options":{"poweredBy":{"name":"顶想云","link":"https:\/\/www.topthink.com"}}}
</script>

    <script src="../asset/lodash/lodash.min.js?v=4.17.21"></script>

    <script src="../asset/react/react.production.min.js?v=18.2.0"></script>

    <script src="../asset/react-dom/react-dom.production.min.js?v=18.2.0"></script>

    <script src="../asset/reader/index.js?v=1.0.66-alpha.7+5dae540"></script>

    <script src="../asset/plugins/highlight/index.js?v=1.0.4"></script>

    <script src="../asset/plugins/image-zoom/index.js?v=0.0.1"></script>

    <script src="../asset/plugins/theme-default/index.js?v=1.0.30"></script>

<script type="text/javascript">
    TopWrite.bootstrap();
</script>
</body>
</html>
