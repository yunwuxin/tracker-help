<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tracker客户端 - Untitled</title>
    
    
</head>
<body>
<div id="root"></div>
<script type="application/payload+json">
{"id":"Jrymro","sha":"164504e743217af9f2c75534a7496bb2b403bd27","summary":[{"title":"","articles":[{"title":"安装说明","ref":"installation.md","path":"installation.html","metadata":{"mtime":"2021-08-26T04:02:01+00:00"},"children":[{"title":"tracker服务端","ref":"installation\/server.md","path":"installation\/server.html","metadata":{"mtime":"2020-10-01T02:43:42+00:00"},"children":[{"title":"数据存储","ref":"installation\/server\/data-storage.md","path":"installation\/server\/data-storage.html","metadata":{"mtime":"2020-03-05T02:13:12+00:00"}},{"title":"更换数据存储配置","ref":"change-db.md","path":"change-db.html","metadata":{"mtime":"2020-09-23T06:27:02+00:00"}},{"title":"Server管理","ref":"installation\/server\/manage.md","path":"installation\/server\/manage.html","metadata":{"mtime":"2020-02-28T03:05:17+00:00"}},{"title":"数据清理","ref":"installation\/clean-log.md","path":"installation\/clean-log.html","metadata":{"mtime":"2021-08-25T06:03:28+00:00"}}]},{"title":"tracker客户端","ref":"installation\/client.md","path":"installation\/client.html","metadata":{"mtime":"2021-08-26T04:02:01+00:00"},"children":[{"title":"系统配置","ref":"installation\/client\/agent-config.md","path":"installation\/client\/agent-config.html"},{"title":"自定义配置","ref":"installation\/client\/user-config.md","path":"installation\/client\/user-config.html"},{"title":"链路追踪扩展","ref":"installation\/client\/trace_tlist.md","path":"installation\/client\/trace_tlist.html"}]},{"title":"上报监控数据","ref":"installation\/reprot.md","path":"installation\/reprot.html"}]},{"title":"名词解释","ref":"noun-interpretation.md","path":"noun-interpretation.html"},{"title":"常见问题","ref":"qa.md","path":"qa.html"},{"title":"首页","ref":"application-list.md","path":"application-list.html"},{"title":"调用统计","ref":"application-monitoring.md","path":"application-monitoring.html"},{"title":"链路追踪","ref":"application-tracking.md","path":"application-tracking.html"},{"title":"调试器适用场景","ref":"debug-explain.md","path":"debug-explain.html"},{"title":"调试器","ref":"debuger.md","path":"debuger.html"},{"title":"免费内存检测工具","ref":"leak.md","path":"leak.html"},{"title":"Agent列表","ref":"agent-list.md","path":"agent-list.html"},{"title":"机器信息","ref":"sysinfo.md","path":"sysinfo.html"},{"title":"报警管理","ref":"alert.md","path":"alert.html"},{"title":"项目管理","ref":"project.md","path":"project.html"},{"title":"应用管理","ref":"module.md","path":"module.html"},{"title":"接口管理","ref":"interface.md","path":"interface.html"},{"title":"用户管理","ref":"user.md","path":"user.html","children":[{"title":"第三方登录","ref":"user\/oauth-login.md","path":"user\/oauth-login.html"}]},{"title":"对外开放API","ref":"api.md","path":"api.html"},{"title":"联系我们","ref":"contact-us.md","path":"contact-us.html"}]}],"config":{"plugins":["highlight","image-zoom"],"pluginsConfig":{"highlight":{"defaultLanguage":"markup"},"theme-default":{"show_nav":true,"logo":{"image":"https:\/\/img.kancloud.cn\/4e\/45\/4e45172f86ac746e40eb69c2827ae271_157x77.png","url":"https:\/\/business.swoole.com\/"}}},"themeConfig":{"expandLevel":1,"navs":[{"title":"Swoole Tracker 详细手册","url":"http:\/\/wiki.tracker.swoole-cloud.com"},{"title":"基础手册","url":"http:\/\/base-wiki.tracker.swoole-cloud.com"}]}},"file":{"path":"installation\/client.html","content":"[TOC]\n\n## 直接部署(非docker的客户端环境)\n\n### 1. 安装对应的`swoole_tracker`扩展\n\n在 `php.ini` 中加入以下配置\n```ini\nextension=swoole_tracker.so\n\n;打开总开关\napm.enable=1\n;采样率 例如：100%\napm.sampling_rate=100\n;开启内存泄漏检测时添加 默认0 关闭状态\napm.enable_memcheck=1\n\n;v3.3.0版本开始修改为了Zend扩展\nzend_extension=swoole_tracker.so\ntracker.enable=1\ntracker.sampling_rate=100\ntracker.enable_memcheck=1\n```\n>[danger] `enable`为 1 时表示调用统计百分百拦截并上报\n> `sampling_rate`采样率只作用于链路追踪，设置为 100 则表示每次请求都会生成一条 trace 数据\n\n### 2. 卸载不兼容扩展\n\n1. xdebug\n2. ioncube loader\n3. zend guard loader\n4. xhprof\n5. swoole_loader （加密后的代码不能进行分析）\n\n### 3. 运行agent\n\n在 node-agent 的目录下的命令行中执行 `.\/deploy_env.sh 127.0.0.1`。(`127.0.0.1`为admin后台的机器ip)\n\n### 4. 重启PHP服务\n\n安装完成扩展后，需要**重启对应的 SwooleServer 或者 php-fpm 服务**，**并且发生请求**后稍等片刻，等待tracker服务端接收客户端发送的数据。\n\n## 在Docker部署\n\n>[danger] 请注意修改相关路径为你自己的路径！！！以下的swoole.so只是演示说明可安装其他扩展，swoole_tracker不依赖swoole扩展\n\n在docker环境部署需要修改Dockerfile或者docker-compose.yml或者在`docker run`命令中添加参数，以下以采用官方docker-compose v3.7配置文件格式，php:fpm-7.x(-alpine)镜像为例，描述如何在docker部署\n\n### 修改Dockerfile以部署node-agent\n\n在Dockerfile中执行deploy_env.sh来部署node-agent，然后在entrypoint中添加node-agent，例如\n\n```dockerfile\n# dockerfile的其他部分\n\n# 部署node-agent\nADD swoole-tracker-vx.y.z.tar.gz \/tmp\/\nRUN tar -C \/ -xvf \/tmp\/swoole-tracker-vx.y.z.tar.gz && \\\n    cd \/swoole-tracker\/node-agent && \\\n    .\/deploy_env.sh 服务端IP && \\\n    rm \/tmp\/swoole-tracker-vx.y.z.tar.gz\n\n# 添加entrypoint脚本\nRUN printf '#!\/bin\/sh\\n\/opt\/swoole\/script\/php\/swoole_php \/opt\/swoole\/node-agent\/src\/node.php &\\nphp-fpm $@' > \/opt\/swoole\/entrypoint.sh && \\\n    chmod 755 \/opt\/swoole\/entrypoint.sh\n\n# 启用entrypoint脚本（-x方便调试， 可以去掉）\nENTRYPOINT [ \"sh\", \"-x\", \"\/opt\/swoole\/entrypoint.sh\" ]\n```\n\n### 启用扩展\n#### 安装依赖\nswoole_tracker依赖mysqlnd, pdo, curl, json扩展，需要在你的docker镜像里添加这几个依赖的扩展\n\n对于官方镜像，他们提供了docker-php-ext-install 命令，可以使用\n```dockerfile\nmysqli pdo pdo_mysql curl json\n```\n来添加这些扩展\n#### 安装tracker扩展\n对于官方镜像php:fpm系列，php(-fpm)默认读取\/usr\/local\/etc\/php\/conf.d下的配置文件，默认的entrypoint会将\"-\"开头的参数作为fpm启动参数，因此可以采用以下方式启用swoole_tracker扩展\n\n在Dockerfile添加配置文件：\n\n```dockerfile\nRUN printf 'extension=\/path\/to\/swoole.so\\nextension=\/path\/to\/swoole_tracker7x.so\\n' > \/usr\/local\/etc\/php\/conf.d\/swoole-tracker.ini\n```\n\n或在docker-compose.yml添加启动参数\n\n```dockerfile\nservices:\n  your-service:\n    build:\n      context: cgi-docker\n      dockerfile: Dockerfile\n    image: myphpfpm:1\n    command:\n      - \"-dextension=\/path\/to\/swoole.so\"\n      - \"-dextension=\/path\/to\/swoole_tracker7x.so\"\n```\n\n或在docker run命令中添加启动参数\n\n```dockerfile\ndocker run --other-arguments myphpfpm:1 -dextension=\/path\/to\/swoole.so -dextension=\/path\/to\/swoole_tracker7x.so\n```\n\n### 配置docker安全选项\n\n> 仅在使用部分调试器功能（如阻塞检测，内存泄漏检测等）时需要进行这些配置\n\n扩展中使用了默认权限不允许的系统调用，使用了docker默认seccomp配置不允许的系统调用，需要额外配置：\n\n>[success] 参考[https:\/\/docs.docker.com\/engine\/security\/seccomp\/](https:\/\/docs.docker.com\/engine\/security\/seccomp\/)\n\n对于权限配置，可以添加SYS_PTRACE cap，或者使用提升权限模式（不推荐）\n\n对于seccomp，可以修改seccomp配置，或关闭seccomp配置（不推荐，这将导致docker内程序可以执行create_module，kexec_load等危险系统调用）\n\n### 修改seccomp配置\n> 仅在使用部分调试器功能（如阻塞检测，内存泄漏检测等）时需要进行这些配置\n\n修改seccomp配置文件（修改自[默认文件](https:\/\/github.com\/moby\/moby\/blob\/master\/profiles\/seccomp\/default.json)）:\n\n```bash\n--- a.json\n+++ b.json\n# 在.syscalls[0].names中加入\"ptrace\"，这将允许ptrace\n@@ -359,7 +359,8 @@\n                                \"waitid\",\n                                \"waitpid\",\n                                \"write\",\n-                               \"writev\"\n+                               \"writev\",\n+                               \"ptrace\"\n                        ],\n                        \"action\": \"SCMP_ACT_ALLOW\",\n                        \"args\": [],\n# 如果你的docker较新，则它已经配置了ptrace在4.8以上内核可用\n# 参考https:\/\/github.com\/moby\/moby\/commit\/1124543ca8071074a537a15db251af46a5189907\n# 移除这段\n@@ -369,18 +370,6 @@\n                },\n-                {\n-                        \"names\": [\n-                               \"ptrace\"\n-                       ],\n-                       \"action\": \"SCMP_ACT_ALLOW\",\n-                       \"args\": null,\n-                       \"comment\": \"\",\n-                       \"includes\": {\n-                               \"minKernel\": \"4.8\"\n-                       },\n-                       \"excludes\": {}\n-               },\n               {\n                       \"names\": [\n                                \"personality\"\n                        ],\n                        \"action\": \"SCMP_ACT_ALLOW\",\n```\n\n在docker run使用该seccomp并给予SYS\\_PTRACE权限：\n\n```bash\ndocker run --other-arguments --cap-add=SYS_PTRACE --security-opt seccomp=\/path\/to\/that\/modified\/profile.json ...\n```\n\n或docker-compose.yml中:\n\n```yml\n# 在docker-compose.yml中：\nservices:\n  your-service:\n    build:\n      context: cgi-docker\n      dockerfile: Dockerfile\n    image: myphpfpm:1\n    # 给予SYS_PTRACE权限\n    cap_add:\n      - \"SYS_PTRACE\"\n    # 配置使用修改的seccomp\n    security_opt:\n      - \"seccomp=\/path\/to\/that\/modified\/profile.json\"\n```\n\n#### 关闭seccomp（不推荐）\n\n与修改配置类似，但不需要创建json，将 `seccomp=\/path\/to\/that\/modified\/profile.json` 换成`seccomp=unconfined`即可\n\n## 单独的NodeAgent容器（高级用法）\n\n此处提供一种单独运行的方法，仅供参考：\n\n```bash\n# 在host安装NodeAgent（或者手动安装\/opt\/swoole的文件）\ncd \/some\/place\/swoole-tracker\/node-agent\n.\/deploy_env.sh 服务端IP\n\n# 开启NodeAgent容器\ndocker run \\\n --name nodeagent \\\n -d --cap-add SYS_PTRACE \\\n --security-opt seccomp=\/path\/to\/modified\/json \\\n --entrypoint \/opt\/swoole\/script\/php\/swoole_php \\\n -v \/var\/run:\/var\/run:rw,rshared,z \\\n -v \/tmp:\/tmp:rw,rshared,z \\\n -v \/opt\/swoole:\/opt\/swoole:rw,rshared,z \\\n alpine:edge \\\n \/opt\/swoole\/node-agent\/src\/node.php\n\n# 开启cgi容器\ndocker run \\\n --name cgi1 \\\n -d \\\n --pid=\"container:nodeagent\" \\\n --net=\"container:nodeagent\" \\\n -v \/var\/run:\/var\/run:rw,rshared,z \\\n -v \/tmp:\/tmp:rw,rshared,z \\\n -v \/opt\/swoole:\/opt\/swoole:rw,rshared,z \\\n php:7.3-fpm\n```\n\n## 管理客户端进程\n\n查看 [常见问题](..\/qa.md) 中的「管理NodeAgent守护进程」","meta":{"mtime":"2021-08-26T04:02:01+00:00"}},"options":{"poweredBy":{"name":"顶想云","link":"https:\/\/www.topthink.com"}}}
</script>

    <script src="../asset/lodash/lodash.min.js?v=4.17.21"></script>

    <script src="../asset/react/react.production.min.js?v=18.2.0"></script>

    <script src="../asset/react-dom/react-dom.production.min.js?v=18.2.0"></script>

    <script src="../asset/reader/index.js?v=1.0.66-alpha.7+5dae540"></script>

    <script src="../asset/plugins/highlight/index.js?v=1.0.4"></script>

    <script src="../asset/plugins/image-zoom/index.js?v=0.0.1"></script>

    <script src="../asset/plugins/theme-default/index.js?v=1.0.30"></script>

<script type="text/javascript">
    TopWrite.bootstrap();
</script>
</body>
</html>
